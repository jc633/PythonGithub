/* @ pluginName:upImg;
   @ author:姜兴春(Runner);
   @ Date:2018-10-21;
   @ function:用于表单中上传图片的在线预览,支持图片格式和大小检测,支持多图预览;
   @ para:preWidth-预览框的宽度 preHeight-预览框的高度 imgNum-上传的图片数 size-图片大小区间
   @ version:1.0;
   @ depends:jquery>1.7
*/

;(function ($,window,document,undefined) {
  var defaults = {
   'preWidth':'150',
	 'preHeight':'150',
	 'imgNum':'1',
	 'size':[20,1024],
   'float':'left',
  };
  //构造方法
  function upImg(ele,opts) {
  	this.element = ele;
  	this.options = $.extend(defaults,opts);
  	this.init();
  }
  //创建相关方法
  upImg.prototype = {
  	//初始化
  	init:function () {
  		var obj = this;
	  	var fontSize = obj.options.preWidth*0.4+'px'; //加号的字体大小
	  	for(var i=0;i<obj.options.imgNum;i++){
	  		var html = '<div class="previewArea" style="float:'+obj.options.float+';width:'+obj.options.preWidth+'px;height:'+obj.options.preHeight+'px;"><div class="chooseImg" title="点击选择图片"><span style="width:'+fontSize+';height:'+fontSize+';font-size:'+fontSize+';">+</span></div><div class="showImg" title="点击重新选择"><img src="xxx"></div></div>'
	  	    $(obj.element).after(html);
	  	  }
        $('.chooseImg').attr('onclick', '$("#upImg").click()');
        $('.showImg').attr('onclick', '$("#upImg").click()');
        if(obj.options.float=='left'){$('.previewArea').eq(0).css('margin-left', '0');}//调整第一个div的位置}
        
  	 },
   //文件检测
   checkFile:function (filelist) {
   	    var obj = this;
   	    min= obj.options.size[0];
   	    max=obj.options.size[1];
	   	if(min>max){var c = min;min = max;max=c;} //防止用户输反参数
		var reg = /\S+\.jpg|png|JPG|PNG|jpeg|JPEG/; //图片验证
		var Minsize = min*1024; 
		var Maxsize = max*1024; 
		min = min>=1024?(min/1024)+'M':min+'kb'; //单位检测
		max = max>=1024?(max/1024)+'M':max+'kb';
		var imgs = filelist.files;
		for(var i =0;i<imgs.length;i++){
			if(reg.test(imgs[i].name)){
	          if(imgs[i].size>=Minsize&&imgs[i].size<=Maxsize){
	             obj.preview(imgs[i],i);
	          }
	          else{alert('图片大小需在'+min+'~'+max+'之间,第'+(i+1)+'张不符合要求');}
			}
			else{alert('第'+(i+1)+'张图片格式不正确!');}
		}
   },
   //预览
   preview:function (file,index) {
   	    var obj = this;
     	var url = obj.getImgUrl(file);
	   if(url){
	   	 $('.showImg').eq(index).find('img').attr('src',url);
	   }
	   $('.chooseImg').eq(index).hide();
	   $('.showImg').eq(index).show();
   },
  //获取图片路径
  getImgUrl:function(file) { 
　　var url = null ; 
　　if (window.createObjectURL!=undefined) { 
　　　　url = window.createObjectURL(file) ; 
　　} else if (window.URL!=undefined) { 
　　　　url = window.URL.createObjectURL(file) ; 
　　} else if (window.webkitURL!=undefined) { 
　　　　url = window.webkitURL.createObjectURL(file) ; 
　　} 
　　return url ; 
  },
 }

 $.fn.upImg = function(opts) {
 	var img =  new upImg(this,opts);
    this.on('change', function(event) {
      $('.showImg').find('img').attr('src', 'xxx');
      $('.chooseImg').show();
      $('.showImg').hide();
    	img.checkFile(this);
    });
 }
})(jQuery,window,document);